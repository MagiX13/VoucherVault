{% extends "base.html" %}
{% load static %}

{% block content %}

<div class="pagetitle">
    <h1>Create New Item</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item active">Create New Item</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

{% if form.type.errors %}
<div class="invalid-feedback">
    {% for error in form.type.errors %}
    <p>{{ error }}</p>
    {% endfor %}
</div>
{% endif %}

<section class="section">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Item Details</h5>
                    <!-- QR Code Scanner Section -->
                    <section class="mb-2 mt-1" id="qrScannerSection" style="display:none;">
                        <div style="color: lightgray" id="loadingMessage">ðŸŽ¥ Unable to access video stream (please make sure you have a webcam enabled)</div>
                        <canvas id="canvas" hidden></canvas>
                        <div id="output" hidden>
                            <div style="color: lightgray" id="outputMessage">No QR code detected.</div>
                            <div style="color: lightgray" hidden><b>Data:</b> <span id="outputData"></span></div>
                        </div>
                    </section>
                    <!-- Item Form -->
                    <form method="POST" action="{% url 'create_item' %}" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="row mb-3">
                            <label for="type" class="col-sm-2 col-form-label">Type</label>
                            <div class="col-sm-10">
                                <select class="form-select" id="type" name="type" required>
                                    <option value="giftcard">Gift Card</option>
                                    <option value="voucher">Voucher</option>
                                    <option value="coupon">Coupon</option>
                                    <option value="loyaltycard">Loyalty Card</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <label for="name" class="col-sm-2 col-form-label">Name</label>
                            <div class="col-sm-10">
                                <input placeholder="The name of the item" type="text" class="form-control" id="name"
                                    name="name" required>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <label for="issuer" class="col-sm-2 col-form-label">Issuer</label>
                            <div class="col-sm-10">
                                <input placeholder="The issuer of the item" type="text" class="form-control mt-2"
                                    id="issuer" name="issuer">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <label for="redeem_code" class="col-sm-2 col-form-label">Redeem Code</label>
                            <div class="col-sm-10">
                                <div class="input-group">
                                    <input placeholder="The redeem code of the item" type="text" class="form-control" id="redeem_code" name="redeem_code" required>
                                    <button class="btn btn-outline-secondary" type="button" class="toggle-value-type" id="startScanner">
                                        <i class="bi bi-camera"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <label for="pin" class="col-sm-2 col-form-label">PIN Code</label>
                            <div class="col-sm-10">
                                <input placeholder="The pin code of the item" type="text" class="form-control" id="pin"
                                    name="pin">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <label for="issue_date" class="col-sm-2 col-form-label">Issue Date</label>
                            <div class="col-sm-10">
                                <input type="date" class="form-control" id="issue_date" name="issue_date" required>
                            </div>
                            <script>
                                document.getElementById('issue_date').valueAsDate = new Date();
                            </script>
                        </div>
                        <div class="row mb-3">
                            <label for="expiry_date" class="col-sm-2 col-form-label">Expiry Date</label>
                            <div class="col-sm-10">
                                <input type="date" class="form-control" id="expiry_date" name="expiry_date" required>
                            </div>
                        </div>
                        <div class="row mb-3">
                          <label for="description" class="col-sm-2 col-form-label">Description</label>
                          <div class="col-sm-10">
                              <textarea placeholder="A description of the item" class="form-control" id="description"
                                  name="description" rows="4"></textarea>
                          </div>
                      </div>
                        <div class="row mb-3" id="value-field">
                            <label for="value" class="col-sm-2 col-form-label">Value</label>
                            <div class="col-sm-10">
                                <div class="input-group">
                                    <input placeholder="The value of the item" type="number" class="form-control"
                                        id="value" name="value" step="0.01" min="0.00" required> 
                                    <button class="btn btn-outline-secondary d-none" type="button" id="toggle-value-type">
                                        <span id="value-type-icon" class="bi bi-cash-coin"></span>
                                    </button>
                                </div>
                                <input type="hidden" id="value_type" name="value_type" value="money">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <label for="file" class="col-sm-2 col-form-label">Upload File</label>
                            <div class="col-sm-10">
                                <input type="file" id="file" name="file" class="form-control">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-sm-10 offset-sm-2">
                                <button type="submit" class="btn btn-primary">Create Item</button>
                            </div>
                        </div>
                    </form><!-- End Item Form -->
                    {% if form.errors %}
                    <div class="alert alert-danger mt-2">
                        <ul>
                            {% for field, errors in form.errors.items %}
                            {% for error in errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

<script src="{% static 'assets/js/jsQR.js' %}"></script>
<script>
  var video = document.createElement("video");
  var canvasElement = document.getElementById("canvas");
  var canvas = canvasElement.getContext("2d");
  var loadingMessage = document.getElementById("loadingMessage");
  var outputContainer = document.getElementById("output");
  var outputMessage = document.getElementById("outputMessage");
  var outputData = document.getElementById("outputData");
  var redeemCodeField = document.getElementById("redeem_code");
  var qrScannerSection = document.getElementById("qrScannerSection");

  function drawLine(begin, end, color) {
    canvas.beginPath();
    canvas.moveTo(begin.x, begin.y);
    canvas.lineTo(end.x, end.y);
    canvas.lineWidth = 4;
    canvas.strokeStyle = color;
    canvas.stroke();
  }

  function tick() {
    loadingMessage.innerText = "âŒ› Loading video..."
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      loadingMessage.hidden = true;
      canvasElement.hidden = true;
      outputContainer.hidden = true;

      canvasElement.height = video.videoHeight;
      canvasElement.width = video.videoWidth;
      canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
      var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
      var code = jsQR(imageData.data, imageData.width, imageData.height, {
        inversionAttempts: "dontInvert",
      });
      if (code) {
        drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#FF3B58");
        drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#FF3B58");
        drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FF3B58");
        drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#FF3B58");
        outputMessage.hidden = true;
        outputData.parentElement.hidden = false;
        outputData.innerText = code.data;
        redeemCodeField.value = code.data;  // Set the redeem code field with scanned data
      } else {
        outputMessage.hidden = false;
        outputData.parentElement.hidden = true;
      }
    }
    requestAnimationFrame(tick);
  }

  document.getElementById("startScanner").addEventListener("click", function() {
    qrScannerSection.style.display = "block";
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(function(stream) {
      video.srcObject = stream;
      video.setAttribute("playsinline", true); // required to tell iOS safari we don't want fullscreen
      video.play();
      requestAnimationFrame(tick);
    }).catch(function(error) {
      loadingMessage.innerText = "ðŸŽ¥ Unable to access video stream: " + error.message;
    });
  });

</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
      const typeField = document.getElementById('type');
      const pinField = document.getElementById('pin');
      const valueField = document.getElementById('value');
      const issuerCodeField = document.getElementById('issuer');
      const redeemCodeField = document.getElementById('redeem_code');
      const pinFieldContainer = pinField.closest('.row');
      const valueFieldContainer = valueField.closest('.row');
      const issuerCodeLabel = document.querySelector('label[for="issuer"]');
      const redeemCodeLabel = document.querySelector('label[for="redeem_code"]');
      const valueTypeIcon = document.getElementById('value-type-icon');
      const toggleValueTypeBtn = document.getElementById('toggle-value-type');
      const valueTypeField = document.getElementById('value_type');

      function toggleFields() {
          if (typeField.value === 'loyaltycard') {
              pinField.readOnly = true;
              valueField.readOnly = true;
              pinField.classList.add('readonly');
              valueField.classList.add('readonly');
              valueField.value = 0;
              issuerCodeLabel.textContent = 'Store';
              issuerCodeField.placeholder = 'The store of your loyalty card'
              redeemCodeLabel.textContent = 'Loyalty ID';
              redeemCodeField.placeholder = 'Loyalty card number or customer ID';
          } else {
              pinField.readOnly = false;
              valueField.readOnly = false;
              valueField.classList.remove('readonly');
              redeemCodeLabel.textContent = 'Redeem Code';
              redeemCodeField.placeholder = 'The redeem code of the item';
          }

          if (typeField.value === 'coupon') {
              toggleValueTypeBtn.classList.remove('d-none');
          } else {
              toggleValueTypeBtn.classList.add('d-none');
          }
      }

      function toggleValueInput() {
          if (valueTypeField.value === 'money') {
              valueTypeField.value = 'percentage';
              valueTypeIcon.classList.remove('bi-cash-coin');
              valueTypeIcon.classList.add('bi-percent');
              valueField.placeholder = "The percentage value of the item";
              valueField.setAttribute('step', '0.01');
              valueField.setAttribute('min', '0.00');
              valueField.setAttribute('max', '100.00');
          } else {
              valueTypeField.value = 'money';
              valueTypeIcon.classList.remove('bi-percent');
              valueTypeIcon.classList.add('bi-cash-coin');
              valueField.placeholder = "The monetary value of the item";
              valueField.setAttribute('step', '0.01');
              valueField.setAttribute('min', '0.00');
              valueField.removeAttribute('max');
          }
      }

      typeField.addEventListener('change', toggleFields);
      toggleValueTypeBtn.addEventListener('click', toggleValueInput);

      toggleFields();  // Initial call to set the correct state on page load
  });
</script>
{% endblock content %}
